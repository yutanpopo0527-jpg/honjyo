<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家族カレンダー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                        otou: { 100: '#dbeafe', 200: '#bfdbfe', 500: '#3b82f6', 600: '#2563eb' },
                        mama: { 100: '#fce7f3', 200: '#fbcfe8', 500: '#ec4899', 600: '#db2777' },
                        mahiru: { 100: '#fef3c7', 200: '#fde68a', 500: '#f59e0b', 600: '#d97706' },
                        ayuha: { 100: '#d1fae5', 200: '#a7f3d0', 500: '#10b981', 600: '#059669' }
                    }
                }
            }
        }
    </script>
    <style>
        .calendar-cell {
            min-height: 80px;
        }

        @media (min-width: 768px) {
            .calendar-cell {
                min-height: 120px;
            }
        }

        .event-item {
            cursor: pointer;
            font-size: 9px;
            line-height: 1.1;
            word-break: break-all;
            white-space: normal;
        }

        @media (min-width: 768px) {
            .event-item {
                font-size: 11px;
                line-height: 1.2;
                cursor: grab;
            }

            .event-item:active {
                cursor: grabbing;
            }
        }

        .select-mode .calendar-cell {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .select-mode .calendar-cell:hover {
            background-color: rgba(59, 130, 246, 0.2);
        }

        .copy-mode-banner {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .drag-over {
            background-color: rgba(59, 130, 246, 0.2);
        }
    </style>
</head>

<body class="bg-primary-50 min-h-screen">
    <div id="app"></div>

    <script>
        // ============================================================
        // Config
        // ============================================================
        const Config = {
            API_URL: 'https://api.jsonbin.io/v3/b',
            SYNC_INTERVAL: 5000,
            CONFIG_KEY: 'familyCalendarConfig',
            EVENTS_KEY: 'familyCalendarEvents',
            CATEGORIES: [
                { id: 'otou', name: 'おとうー', color: 'otou' },
                { id: 'mama', name: 'まま', color: 'mama' },
                { id: 'mahiru', name: 'まひる', color: 'mahiru' },
                { id: 'ayuha', name: 'あゆは', color: 'ayuha' }
            ]
        };

        // ============================================================
        // State (グローバル状態)
        // ============================================================
        const state = {
            currentDate: new Date(),
            events: [],
            config: null,
            filterCategory: null,
            selectMode: null,
            selectedEventId: null,
            lastSync: null,
            syncStatus: 'idle' // 'idle', 'syncing', 'error', 'success'
        };

        // ============================================================
        // Utils
        // ============================================================
        const Utils = {
            formatDate: (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`,
            generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2),

            getTimeOptions() {
                const opts = [];
                for (let h = 0; h <= 23; h++) {
                    for (let m = 0; m < 60; m += 30) {
                        opts.push(`${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
                    }
                }
                return opts;
            },

            holidays: {
                '2026-01-01': '元日', '2026-01-12': '成人の日', '2026-02-11': '建国記念の日', '2026-02-23': '天皇誕生日',
                '2026-03-20': '春分の日', '2026-04-29': '昭和の日', '2026-05-03': '憲法記念日', '2026-05-04': 'みどりの日',
                '2026-05-05': 'こどもの日', '2026-05-06': '振替休日', '2026-07-20': '海の日', '2026-08-11': '山の日',
                '2026-09-21': '敬老の日', '2026-09-22': '国民の休日', '2026-09-23': '秋分の日', '2026-10-12': 'スポーツの日',
                '2026-11-03': '文化の日', '2026-11-23': '勤労感謝の日'
            },

            getCalendarDays(year, month) {
                const first = new Date(year, month, 1);
                const last = new Date(year, month + 1, 0);
                const days = [];
                for (let i = first.getDay() - 1; i >= 0; i--) days.push({ date: new Date(year, month, -i), current: false });
                for (let i = 1; i <= last.getDate(); i++) days.push({ date: new Date(year, month, i), current: true });
                while (days.length < 42) days.push({ date: new Date(year, month + 1, days.length - last.getDate() - first.getDay() + 1), current: false });
                return days;
            },

            getCategoryById(id) {
                return Config.CATEGORIES.find(c => c.id === id) || Config.CATEGORIES[0];
            },

            parseICS(text) {
                const events = [];
                const lines = text.replace(/\r\n /g, '').split(/\r\n|\n|\r/);
                let ev = null;
                for (const line of lines) {
                    if (line === 'BEGIN:VEVENT') ev = { id: this.generateId(), category: 'otou', memo: '' };
                    else if (line === 'END:VEVENT' && ev && ev.date && ev.title) { events.push(ev); ev = null; }
                    else if (ev) {
                        if (line.startsWith('DTSTART')) {
                            const m = line.match(/(\d{4})(\d{2})(\d{2})(?:T(\d{2})(\d{2}))?/);
                            if (m) { ev.date = `${m[1]}-${m[2]}-${m[3]}`; ev.startTime = m[4] && m[5] ? `${m[4]}:${m[5]}` : '09:00'; }
                        } else if (line.startsWith('DTEND')) {
                            const m = line.match(/T(\d{2})(\d{2})/);
                            if (m) ev.endTime = `${m[1]}:${m[2]}`;
                        } else if (line.startsWith('SUMMARY:')) ev.title = line.substring(8);
                        else if (line.startsWith('DESCRIPTION:')) ev.memo = line.substring(12);
                    }
                }
                return events;
            }
        };

        // ============================================================
        // Storage (ローカル保存)
        // ============================================================
        const Storage = {
            loadConfig() {
                try { state.config = JSON.parse(localStorage.getItem(Config.CONFIG_KEY)); } catch (e) { state.config = null; }
            },
            saveConfig() {
                localStorage.setItem(Config.CONFIG_KEY, JSON.stringify(state.config));
            },
            loadEvents() {
                try {
                    const data = JSON.parse(localStorage.getItem(Config.EVENTS_KEY));
                    if (data && data.events) state.events = data.events;
                } catch (e) { }
            },
            saveEvents() {
                localStorage.setItem(Config.EVENTS_KEY, JSON.stringify({ events: state.events, savedAt: Date.now() }));
            },
            reset() {
                localStorage.removeItem(Config.CONFIG_KEY);
                localStorage.removeItem(Config.EVENTS_KEY);
                state.config = null;
                state.events = [];
            }
        };

        // ============================================================
        // CloudAPI (JSONBin.io)
        // ============================================================
        const CloudAPI = {
            getHeader() {
                if (!state.config) return {};
                const key = state.config.keyType === 'access' ? 'X-Access-Key' : 'X-Master-Key';
                return { [key]: state.config.apiKey, 'Content-Type': 'application/json' };
            },

            async createBin(apiKey, keyType) {
                const key = keyType === 'access' ? 'X-Access-Key' : 'X-Master-Key';
                const res = await fetch(Config.API_URL, {
                    method: 'POST',
                    headers: { [key]: apiKey, 'Content-Type': 'application/json', 'X-Bin-Private': 'false' },
                    body: JSON.stringify({ events: [], updatedAt: Date.now() })
                });
                if (!res.ok) throw new Error('Bin作成失敗');
                const json = await res.json();
                return json.metadata.id;
            },

            async save() {
                if (!state.config) return false;
                state.syncStatus = 'syncing';
                updateSyncIndicator();
                try {
                    const res = await fetch(`${Config.API_URL}/${state.config.binId}`, {
                        method: 'PUT',
                        headers: this.getHeader(),
                        body: JSON.stringify({ events: state.events, updatedAt: Date.now() })
                    });
                    if (!res.ok) throw new Error('保存失敗');
                    state.syncStatus = 'success';
                    state.lastSync = new Date();
                    console.log('Cloud save OK:', state.events.length, 'events');
                    return true;
                } catch (e) {
                    console.error('Cloud save error:', e);
                    state.syncStatus = 'error';
                    return false;
                } finally {
                    updateSyncIndicator();
                }
            },

            async load() {
                if (!state.config) return false;
                state.syncStatus = 'syncing';
                updateSyncIndicator();
                try {
                    const res = await fetch(`${Config.API_URL}/${state.config.binId}/latest`, {
                        headers: this.getHeader()
                    });
                    if (!res.ok) throw new Error('読み込み失敗');
                    const json = await res.json();
                    if (json.record && json.record.events) {
                        state.events = json.record.events;
                        Storage.saveEvents();
                        console.log('Cloud load OK:', state.events.length, 'events');
                    }
                    state.syncStatus = 'success';
                    state.lastSync = new Date();
                    return true;
                } catch (e) {
                    console.error('Cloud load error:', e);
                    state.syncStatus = 'error';
                    return false;
                } finally {
                    updateSyncIndicator();
                    renderCalendar();
                }
            }
        };

        // ============================================================
        // UI更新関数
        // ============================================================
        function updateSyncIndicator() {
            const el = document.getElementById('syncStatus');
            if (!el) return;
            const labels = { idle: '---', syncing: '同期中...', error: '同期エラー', success: '同期済' };
            el.textContent = labels[state.syncStatus] || '---';
            el.className = state.syncStatus === 'error' ? 'text-xs text-red-300' : 'text-xs';
        }

        function renderCalendar() {
            const container = document.getElementById('calendarGrid');
            if (!container) return;

            const y = state.currentDate.getFullYear(), m = state.currentDate.getMonth();
            const days = Utils.getCalendarDays(y, m);
            const today = Utils.formatDate(new Date());
            const events = state.filterCategory ? state.events.filter(e => e.category === state.filterCategory) : state.events;

            container.innerHTML = days.map(d => {
                const dateStr = Utils.formatDate(d.date);
                const dayEvents = events.filter(e => e.date === dateStr).sort((a, b) => a.startTime.localeCompare(b.startTime));
                const isToday = dateStr === today;
                const holiday = Utils.holidays[dateStr];
                const isSun = d.date.getDay() === 0, isSat = d.date.getDay() === 6;

                const evHtml = dayEvents.map(e => {
                    const cat = Utils.getCategoryById(e.category);
                    return `<div class="event-item p-1 rounded text-white bg-${cat.color}-500" onclick="event.stopPropagation(); openEditEvent('${e.id}')">${e.startTime} ${e.title}</div>`;
                }).join('');

                return `
            <div class="calendar-cell border-b border-r border-primary-100 p-1 ${d.current ? 'bg-white' : 'bg-gray-50'} cursor-pointer hover:bg-primary-50" onclick="handleCellClick('${dateStr}')">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs md:text-sm font-semibold ${isToday ? 'bg-primary-500 text-white rounded-full w-6 h-6 flex items-center justify-center' : ''} ${isSun || holiday ? 'text-red-500' : isSat ? 'text-blue-500' : ''}">${d.date.getDate()}</span>
                    ${holiday ? `<span class="text-[9px] text-red-500 truncate hidden md:block">${holiday}</span>` : ''}
                </div>
                <div class="space-y-1">${evHtml}</div>
            </div>`;
            }).join('');

            // ヘッダー更新
            document.getElementById('monthLabel').textContent = `${y}年${m + 1}月`;
        }

        function renderFilterButtons() {
            const container = document.getElementById('filterButtons');
            if (!container) return;

            const allBtn = `<button onclick="setFilter(null)" class="px-2 py-1 rounded text-xs ${!state.filterCategory ? 'bg-gray-600 text-white' : 'bg-gray-100'}">全て</button>`;
            const catBtns = Config.CATEGORIES.map(c =>
                `<button onclick="setFilter('${c.id}')" class="px-2 py-1 rounded text-xs ${state.filterCategory === c.id ? `bg-${c.color}-500 text-white` : `bg-${c.color}-100 text-${c.color}-700`}">${c.name}</button>`
            ).join('');
            container.innerHTML = allBtn + catBtns;
        }

        // ============================================================
        // メイン画面レンダリング
        // ============================================================
        function render() {
            const app = document.getElementById('app');

            if (!state.config) {
                app.innerHTML = `
            <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-primary-100 to-primary-200">
                <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                    <div class="text-center mb-6">
                        <h1 class="text-2xl font-bold text-primary-800">家族カレンダー</h1>
                        <p class="text-primary-600 mt-2 text-sm">家族で予定を共有しましょう</p>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">API Keyの種類</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="radio" name="keyType" value="master" checked> Master Key</label>
                                <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="radio" name="keyType" value="access"> Access Key</label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">JSONBin.io APIキー</label>
                            <input type="text" id="apiKey" placeholder="$2a$10$..." class="w-full px-4 py-3 border rounded-lg">
                            <p class="text-xs text-gray-500 mt-1"><a href="https://jsonbin.io/" target="_blank" class="text-primary-600 underline">jsonbin.io</a> で取得</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bin ID（家族と共有する場合）</label>
                            <input type="text" id="binId" placeholder="省略可能" class="w-full px-4 py-3 border rounded-lg">
                        </div>
                        <button onclick="setupConfig()" class="w-full bg-primary-600 hover:bg-primary-700 text-white py-3 rounded-lg font-semibold">はじめる</button>
                    </div>
                </div>
            </div>`;
                return;
            }

            app.innerHTML = `
        <header class="bg-gradient-to-r from-primary-600 to-primary-700 text-white p-4 shadow-lg sticky top-0 z-40">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold">家族カレンダー</h1>
                <div class="flex items-center gap-2">
                    <span id="syncStatus" class="text-xs">---</span>
                    <button onclick="manualSync()" class="bg-primary-800 hover:bg-primary-900 px-2 py-1 rounded text-xs">再同期</button>
                    <button onclick="resetConfig()" class="bg-primary-800 hover:bg-primary-900 px-2 py-1 rounded text-xs">設定</button>
                </div>
            </div>
        </header>
        <main class="max-w-4xl mx-auto p-2 md:p-4">
            <div class="bg-white rounded-lg shadow p-3 mb-3">
                <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
                    <div class="flex items-center gap-2">
                        <button onclick="prevMonth()" class="p-2 hover:bg-primary-100 rounded-lg">◀</button>
                        <span id="monthLabel" class="text-lg font-bold text-primary-800"></span>
                        <button onclick="nextMonth()" class="p-2 hover:bg-primary-100 rounded-lg">▶</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="goToday()" class="bg-primary-100 hover:bg-primary-200 px-3 py-1 rounded text-sm">今日</button>
                        <label class="bg-green-100 hover:bg-green-200 px-3 py-1 rounded text-sm cursor-pointer">ICS読込<input type="file" accept=".ics" onchange="importICS(event)" class="hidden"></label>
                    </div>
                </div>
                <div id="filterButtons" class="flex items-center gap-2 flex-wrap"></div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="grid grid-cols-7 bg-primary-100">
                    ${['日', '月', '火', '水', '木', '金', '土'].map((d, i) => `<div class="p-2 text-center font-bold text-sm ${i === 0 ? 'text-red-500' : i === 6 ? 'text-blue-500' : 'text-primary-800'}">${d}</div>`).join('')}
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 border-t border-primary-200"></div>
            </div>
        </main>`;

            renderCalendar();
            renderFilterButtons();
            updateSyncIndicator();
        }

        // ============================================================
        // イベント操作関数
        // ============================================================
        async function setupConfig() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const keyType = document.querySelector('input[name="keyType"]:checked').value;
            let binId = document.getElementById('binId').value.trim();

            if (!apiKey) { alert('APIキーを入力してください'); return; }

            try {
                if (!binId) {
                    binId = await CloudAPI.createBin(apiKey, keyType);
                    alert('カレンダーを作成しました！\n家族と共有するには以下のBin IDを伝えてください:\n\n' + binId);
                }
                state.config = { apiKey, binId, keyType };
                Storage.saveConfig();
                render();
                await CloudAPI.load();
            } catch (e) {
                alert('エラー: ' + e.message);
            }
        }

        function resetConfig() {
            if (confirm('設定をリセットしますか？')) {
                Storage.reset();
                render();
            }
        }

        function prevMonth() { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); }
        function nextMonth() { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); }
        function goToday() { state.currentDate = new Date(); renderCalendar(); }
        function setFilter(cat) { state.filterCategory = cat; renderFilterButtons(); renderCalendar(); }

        function handleCellClick(date) {
            if (state.selectMode) {
                executeSelectMode(date);
            } else {
                openAddEvent(date);
            }
        }

        function openAddEvent(date) {
            showModal('予定を追加', eventFormHtml(null, date));
        }

        function openEditEvent(id) {
            const ev = state.events.find(e => e.id === id);
            if (ev) showModal('予定を編集', eventFormHtml(ev));
        }

        function eventFormHtml(ev, date = '') {
            const isEdit = !!ev;
            const e = ev || { title: '', startTime: '09:00', endTime: '10:00', category: 'otou', memo: '' };
            const d = ev ? ev.date : date;
            const cats = Config.CATEGORIES.map(c => `<option value="${c.id}" ${e.category === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const times = Utils.getTimeOptions().map(t => `<option value="${t}">${t}</option>`).join('');

            return `
        <form onsubmit="saveEvent(event, ${isEdit ? `'${e.id}'` : 'null'}, '${d}')">
            <div class="space-y-4">
                <div><label class="block text-sm font-medium mb-1">予定</label>
                    <input type="text" name="title" value="${e.title}" required class="w-full border rounded px-3 py-2"></div>
                <div><label class="block text-sm font-medium mb-1">誰の予定？</label>
                    <select name="category" class="w-full border rounded px-3 py-2">${cats}</select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium mb-1">開始</label>
                        <select name="startTime" class="w-full border rounded px-3 py-2">${times.replace(`value="${e.startTime}"`, `value="${e.startTime}" selected`)}</select></div>
                    <div><label class="block text-sm font-medium mb-1">終了</label>
                        <select name="endTime" class="w-full border rounded px-3 py-2">${times.replace(`value="${e.endTime || e.startTime}"`, `value="${e.endTime || e.startTime}" selected`)}</select></div>
                </div>
                <div><label class="block text-sm font-medium mb-1">メモ</label>
                    <textarea name="memo" class="w-full border rounded px-3 py-2 h-20">${e.memo || ''}</textarea></div>
            </div>
            <div class="mt-4 flex gap-2 justify-end">
                ${isEdit ? `<button type="button" onclick="deleteEvent('${e.id}')" class="px-4 py-2 bg-red-500 text-white rounded">削除</button>` : ''}
                <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded">キャンセル</button>
                <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded">保存</button>
            </div>
        </form>`;
        }

        async function saveEvent(e, id, date) {
            e.preventDefault();
            const form = e.target;
            const data = {
                id: id || Utils.generateId(),
                date: date,
                title: form.title.value,
                startTime: form.startTime.value,
                endTime: form.endTime.value,
                category: form.category.value,
                memo: form.memo.value
            };

            if (id) {
                const idx = state.events.findIndex(ev => ev.id === id);
                if (idx !== -1) state.events[idx] = data;
            } else {
                state.events.push(data);
            }

            Storage.saveEvents();
            closeModal();
            renderCalendar();
            await CloudAPI.save();
        }

        async function deleteEvent(id) {
            if (confirm('この予定を削除しますか？')) {
                state.events = state.events.filter(e => e.id !== id);
                Storage.saveEvents();
                closeModal();
                renderCalendar();
                await CloudAPI.save();
            }
        }

        function showModal(title, content) {
            const html = `
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="if(event.target===this)closeModal()">
            <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                <h2 class="text-xl font-bold mb-4 text-primary-800">${title}</h2>
                ${content}
            </div>
        </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function closeModal() { document.getElementById('modal')?.remove(); }

        async function manualSync() {
            await CloudAPI.load();
        }

        async function importICS(e) {
            const file = e.target.files[0];
            if (!file) return;
            const text = await file.text();
            const events = Utils.parseICS(text);
            if (events.length === 0) { alert('読み込める予定がありません'); return; }

            const cat = prompt(`${events.length}件読み込みます。誰の予定？\n1:おとうー 2:まま 3:まひる 4:あゆは`, '1');
            const catMap = { '1': 'otou', '2': 'mama', '3': 'mahiru', '4': 'ayuha' };
            events.forEach(ev => {
                ev.category = catMap[cat] || 'otou';
                if (!ev.endTime) ev.endTime = ev.startTime;
                state.events.push(ev);
            });

            Storage.saveEvents();
            renderCalendar();
            await CloudAPI.save();
            alert(`${events.length}件読み込みました`);
            e.target.value = '';
        }

        // ============================================================
        // 初期化
        // ============================================================
        Storage.loadConfig();
        Storage.loadEvents();
        render();

        if (state.config) {
            // 初回読み込み
            CloudAPI.load();
            // 定期同期
            setInterval(() => CloudAPI.load(), Config.SYNC_INTERVAL);
        }
    </script>
</body>

</html>
